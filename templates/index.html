{% extends "base.html" %}

{% block content %}
    <h2>Find Your Movie Recommendations</h2>
    <form method="POST" action="{{ url_for('index') }}">
        <div class="form-group">
            <label for="genres">Select Genres:</label>
            <select name="genres" id="genres" multiple required>
                <option value="Any" {% if 'Any' in selected_genres %}selected{% endif %}>Any</option>
                {% for genre in genres %}
                    <option value="{{ genre }}" {% if genre in selected_genres %}selected{% endif %}>{{ genre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="min_year">Minimum Release Year:</label>
            <input type="number" id="min_year" name="min_year" min="1900" max="2024" value="{{ min_year }}" required>
        </div>

        <div class="form-group">
            <label for="max_year">Maximum Release Year:</label>
            <input type="number" id="max_year" name="max_year" min="1900" max="2024" value="{{ max_year }}" required>
        </div>

        <div class="form-group">
            <label for="min_rating">Minimum IMDB Rating (out of 10):</label>
            <input type="number" id="min_rating" name="min_rating" min="0" max="10" step="0.1" value="{{ min_rating }}" required>
        </div>

        <div class="form-group">
            <label for="director">Director:</label>
            <select name="director" id="director">
                <option value="">Any</option>
                {% for director in directors %}
                    <option value="{{ director }}" {% if director == selected_director %}selected{% endif %}>{{ director }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="sort_by">Sort By:</label>
            <select name="sort_by" id="sort_by" required>
                <option value="rating_desc" {% if sort_by == 'rating_desc' %}selected{% endif %}>Rating: High to Low</option>
                <option value="rating_asc" {% if sort_by == 'rating_asc' %}selected{% endif %}>Rating: Low to High</option>
                <option value="year_desc" {% if sort_by == 'year_desc' %}selected{% endif %}>Year: Newest First</option>
                <option value="year_asc" {% if sort_by == 'year_asc' %}selected{% endif %}>Year: Oldest First</option>
            </select>
        </div>

        <button type="submit">Get Recommendations</button>
    </form>

    {% if movies is not none %}
        <div class="movies">
            {% if movies %}
                <h2>Recommended Movies:</h2>

                <!-- Search Input -->
                <input type="text" id="search-input" placeholder="Search movies..." class="search-box">

                <div class="movie-list" id="movie-list">
                    {% for movie in movies %}
                        <div class="movie-card">
                            <a href="{{ url_for('movie_detail', movie_id=movie['id']) }}">
                                <img src="{{ movie['Poster_Link'] }}" alt="{{ movie['Series_Title'] }} Poster">
                            </a>
                            <h3>{{ movie['Series_Title'] }} ({{ movie['Released_Year'] }})</h3>
                            <p><strong>Rating:</strong> {{ movie['IMDB_Rating'] }}/10</p>
                            <p><strong>Genre:</strong> {{ movie['Genre'] }}</p>
                            <!-- Add to Favorites -->
                            {% if movie['is_favorite'] %}
                                <a href="{{ url_for('remove_favorite', movie_id=movie['id']) }}" class="favorite-btn">Remove from Favorites</a>
                            {% else %}
                                <a href="{{ url_for('add_favorite', movie_id=movie['id']) }}" class="favorite-btn">Add to Favorites</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Truncated Pagination Controls -->
                <div class="pagination">
                    {% if page > 1 %}
                        <a href="?page=1" class="first">First</a>
                        <a href="?page={{ page - 1 }}" class="prev">Previous</a>
                    {% endif %}

                    {% set visible_pages = 5 %}
                    {% set start_page = page - (visible_pages // 2) %}
                    {% set end_page = page + (visible_pages // 2) %}

                    {% if start_page < 1 %}
                        {% set start_page = 1 %}
                        {% set end_page = visible_pages %}
                    {% endif %}

                    {% if end_page > total_pages %}
                        {% set end_page = total_pages %}
                        {% set start_page = total_pages - visible_pages + 1 %}
                        {% if start_page < 1 %}
                            {% set start_page = 1 %}
                        {% endif %}
                    {% endif %}

                    {% if start_page > 1 %}
                        <span class="ellipsis">...</span>
                    {% endif %}

                    {% for p in range(start_page, end_page + 1) %}
                        {% if p == page %}
                            <span class="current">{{ p }}</span>
                        {% else %}
                            <a href="?page={{ p }}">{{ p }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if end_page < total_pages %}
                        <span class="ellipsis">...</span>
                    {% endif %}

                    {% if page < total_pages %}
                        <a href="?page={{ page + 1 }}" class="next">Next</a>
                        <a href="?page={{ total_pages }}" class="last">Last</a>
                    {% endif %}
                </div>

            {% else %}
                <h2>No recommendations available based on your preferences.</h2>
            {% endif %}
        </div>
    {% endif %}
{% endblock %}
